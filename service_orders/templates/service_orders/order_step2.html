{% extends "core/base.html" %}
{% block title %}Novo Pedido — Dados{% endblock %}
{% block content %}
<div class="bg-white rounded-lg shadow-md p-0 overflow-hidden">
  <div class="flex items-center justify-between px-4 py-3 border-b border-gray-200">
    <h1 class="text-lg font-semibold text-secondary">Dados do Pedido</h1>
    <div class="flex gap-1" aria-label="Etapas">
      <span class="w-2 h-2 rounded-full bg-primary"></span>
      <span class="w-2 h-2 rounded-full bg-primary"></span>
      <span class="w-2 h-2 rounded-full bg-gray-300"></span>
    </div>
  </div>

  <form method="post" id="step2Form" data-lock-company="{{ lock_company|yesno:'true,false' }}">
    {% csrf_token %}

    <div class="p-4 space-y-4">
      {% if form.non_field_errors %}
        <div class="p-3 rounded-md bg-red-50 border border-red-200 text-red-700 text-sm">
          {{ form.non_field_errors }}
        </div>
      {% endif %}
      <div class="grid grid-cols-1 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">Empresa (opcional)</label>
          {% if lock_company %}
            <div class="px-3 py-2 bg-gray-50 border border-gray-200 rounded">{% if fixed_company %}{{ fixed_company.name }}{% else %}— Avulso{% endif %}</div>
            {% if fixed_company %}
              <input type="hidden" name="company" value="{{ fixed_company.id }}" />
              <div id="fixed-company-meta" data-name="{{ fixed_company.name|escapejs }}" data-cnpj="{{ fixed_company.cnpj|escapejs }}"></div>
            {% endif %}
          {% else %}
            {{ form.company }}
            <p class="text-xs text-gray-500 mt-1">Selecione uma empresa cadastrada ou deixe em branco para pedido avulso.</p>
          {% endif %}
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Cliente</label>
          {{ form.client }}
          {{ form.client.errors }}
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">CNPJ</label>
          {{ form.cnpj_cpf }}
          {{ form.cnpj_cpf.errors }}
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Quantidade de caminhões</label>
          {{ form.truck_count }}
          {{ form.truck_count.errors }}
          <p class="text-xs text-gray-500 mt-1">Máximo de 10 caminhões.</p>
        </div>
      </div>

      <div class="mt-2">
        <h2 class="text-base font-medium text-secondary mb-2">Caminhões</h2>
        {{ formset.management_form }}
        <div id="trucksWrapper" class="space-y-3">
          {% for f in formset %}
            <div class="truck-form p-3 border border-gray-200 rounded-md" data-index="{{ forloop.counter0 }}">
              <div class="text-sm font-semibold text-secondary mb-2">Caminhão {{ forloop.counter }}</div>
              <div class="grid grid-cols-1 gap-3">
                <div>
                  <label class="block text-sm font-medium text-gray-700">Data</label>
                  {{ f.date }}
                  {{ f.date.errors }}
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700">Placa</label>
                  {{ f.plate }}
                  {{ f.plate.errors }}
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700">Frota</label>
                  {{ f.fleet }}
                  {{ f.fleet.errors }}
                </div>
              </div>
              {% with obs_val=f.observation.value price_val=f.observation_price.value %}
              <div class="mt-3 border-t border-dashed border-gray-200 pt-3">
                <button type="button" class="text-sm font-medium text-primary hover:text-secondary transition-colors" data-obs-toggle aria-expanded="{% if obs_val or price_val %}true{% else %}false{% endif %}">
                  <span data-obs-toggle-label>{% if obs_val or price_val %}Ocultar observação{% else %}Incluir observação{% endif %}</span>
                </button>
                <div class="mt-3 space-y-2 {% if not obs_val and not price_val %}hidden{% endif %}" data-obs-fields>
                  <div>
                    <label class="block text-sm font-medium text-gray-700">Observação</label>
                    {{ f.observation }}
                    {{ f.observation.errors }}
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700">Valor da observação</label>
                    {{ f.observation_price }}
                    {{ f.observation_price.errors }}
                    <p class="text-xs text-gray-500 mt-1">Deixe em branco para não adicionar valor extra.</p>
                  </div>
                </div>
              </div>
              {% endwith %}

              <!-- Observações adicionais -->
              <div class="mt-3 border-t border-dashed border-gray-200 pt-3" data-extra-obs-wrap>
                <div class="flex items-center justify-between mb-2">
                  <div class="text-sm font-medium text-secondary">Observações adicionais</div>
                  <button type="button" class="text-sm text-primary hover:text-secondary" data-add-extra>Adicionar outra</button>
                </div>
                <div class="space-y-2" data-extra-list>
                  {% if f.instance.pk and f.instance.observations.all %}
                    {% for ob in f.instance.observations.all %}
                      <div class="grid grid-cols-1 gap-2 p-2 border border-gray-200 rounded" data-extra-item>
                        <div>
                          <label class="block text-xs text-gray-600">Observação</label>
                          <textarea name="extra_obs-{{ forloop.parentloop.counter0 }}-text[]" rows="2" class="w-full">{{ ob.content }}</textarea>
                        </div>
                        <div>
                          <label class="block text-xs text-gray-600">Valor</label>
                          <input type="number" step="0.01" min="0" name="extra_obs-{{ forloop.parentloop.counter0 }}-price[]" class="w-full" value="{{ ob.price|default_if_none:'' }}" />
                        </div>
                      </div>
                    {% endfor %}
                  {% endif %}
                </div>
              </div>
              {{ f.non_field_errors }}
            </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <div class="flex items-center justify-between px-4 py-3 border-t border-gray-200">
      <div class="flex items-center gap-2">
        {% if is_edit %}
          <a href="{% url 'service_orders:order_detail' order.id %}" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-secondary rounded-md">Voltar aos detalhes</a>
          <a href="{% url 'service_orders:order_edit_step1' order.id %}" class="px-3 py-1.5 text-sm text-gray-600 hover:text-gray-800 underline">Etapa anterior</a>
        {% else %}
          <a href="{% url 'service_orders:order_create' %}" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-secondary rounded-md">Voltar</a>
        {% endif %}
      </div>
      <button type="submit" class="px-4 py-2 bg-primary hover:bg-primary/90 text-secondary rounded-md">Avançar</button>
    </div>
  </form>
</div>

  {{ companies_data|json_script:"companies-data" }}
  <script>
  (function() {
    const countInput = document.getElementById('id_truck_count');
    const wrapper = document.getElementById('trucksWrapper');
    const lockCompany = (function(){ try { return JSON.parse(document.getElementById('step2Form').getAttribute('data-lock-company')); } catch(e) { return false; } })();

    function todayStr() {
      const d = new Date();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${d.getFullYear()}-${m}-${day}`;
    }

    function updateVisible() {
      if (!countInput || !wrapper) return;
      const n = Math.max(1, Math.min(10, parseInt(countInput.value || '1', 10)));
      const blocks = wrapper.querySelectorAll('.truck-form');
      blocks.forEach((el, idx) => {
        const show = idx < n;
        el.style.display = show ? '' : 'none';
        const fields = el.querySelectorAll('input, select, textarea');
        fields.forEach((f) => {
          if (show) {
            f.disabled = false;
            // preenche a data se estiver vazia
            if (f.type === 'date' && !f.value) {
              f.value = todayStr();
            }
          } else {
            f.disabled = true;
          }
        });
      });
      // Não altere TOTAL_FORMS (evita inconsistências de formset)
    }

    if (countInput) {
      countInput.addEventListener('input', updateVisible);
      updateVisible();
    }

    // Sincronizar cliente/CNPJ quando uma empresa é selecionada
    const companySelect = document.getElementById('id_company');
    const clientInput = document.getElementById('id_client');
    const cnpjInput = document.getElementById('id_cnpj_cpf');

    // Dados de empresas via JSON seguro do Django
    let companiesArr = [];
    try {
      const el = document.getElementById('companies-data');
      if (el && el.textContent) {
        companiesArr = JSON.parse(el.textContent);
      }
    } catch (e) {
      companiesArr = [];
    }
    const companies = Object.fromEntries((companiesArr || []).map(c => [String(c.id), {name: c.name || '', cnpj: c.cnpj || ''}]));

    function applyCompany() {
      const val = companySelect ? companySelect.value : '';
      if (!companySelect) return;
      if (val) {
        const data = companies[val];
        if (data) {
          clientInput.value = data.name;
          cnpjInput.value = data.cnpj;
          if (window.applyCnpjMask) {
            window.applyCnpjMask(cnpjInput);
          }
        }
        clientInput.setAttribute('readonly', 'readonly');
        cnpjInput.setAttribute('readonly', 'readonly');
      } else {
        clientInput.removeAttribute('readonly');
        cnpjInput.removeAttribute('readonly');
      }
    }
    // Se a empresa estiver travada, aplica via meta
    if (lockCompany) {
      const meta = document.getElementById('fixed-company-meta');
      if (meta && clientInput && cnpjInput) {
        const n = meta.getAttribute('data-name') || '';
        const c = meta.getAttribute('data-cnpj') || '';
        if (n) clientInput.value = n;
        if (c) cnpjInput.value = c;
        if (window.applyCnpjMask) {
          window.applyCnpjMask(cnpjInput);
        }
        clientInput.setAttribute('readonly', 'readonly');
        cnpjInput.setAttribute('readonly', 'readonly');
      } else {
        if (clientInput) clientInput.removeAttribute('readonly');
        if (cnpjInput) cnpjInput.removeAttribute('readonly');
      }
    }

    if (companySelect && clientInput && cnpjInput && !lockCompany) {
      companySelect.addEventListener('change', applyCompany);
      applyCompany();
    }

    function initObservationToggles() {
      const forms = document.querySelectorAll('.truck-form');
      forms.forEach(function (form) {
        const toggle = form.querySelector('[data-obs-toggle]');
        const fields = form.querySelector('[data-obs-fields]');
        if (!toggle || !fields) return;
        const label = toggle.querySelector('[data-obs-toggle-label]');

        function setState(open) {
          fields.classList.toggle('hidden', !open);
          toggle.setAttribute('aria-expanded', open ? 'true' : 'false');
          if (label) {
            label.textContent = open ? 'Ocultar observação' : 'Incluir observação';
          }
        }

        let isOpen = !fields.classList.contains('hidden');
        setState(isOpen);

        toggle.addEventListener('click', function () {
          isOpen = !fields.classList.contains('hidden');
          setState(!isOpen);
        });
      });
    }

    initObservationToggles();
  })();
</script>
<script>
  // Adicionar/remover linhas de observações adicionais por caminhão
  (function() {
    function onAddClick(e) {
      const wrap = e.currentTarget.closest('[data-extra-obs-wrap]');
      if (!wrap) return;
      const truckDiv = wrap.closest('.truck-form');
      const idx = truckDiv ? truckDiv.getAttribute('data-index') : '0';
      const list = wrap.querySelector('[data-extra-list]');
      const item = document.createElement('div');
      item.className = 'grid grid-cols-1 gap-2 p-2 border border-gray-200 rounded';
      item.setAttribute('data-extra-item', '');
      item.innerHTML = `
        <div>
          <label class="block text-xs text-gray-600">Observação</label>
          <textarea name="extra_obs-${idx}-text[]" rows="2" class="w-full"></textarea>
        </div>
        <div>
          <label class="block text-xs text-gray-600">Valor</label>
          <input type="number" step="0.01" min="0" name="extra_obs-${idx}-price[]" class="w-full" />
        </div>`;
      list.appendChild(item);
    }
    document.querySelectorAll('[data-add-extra]').forEach(btn => btn.addEventListener('click', onAddClick));
  })();
</script>
{% endblock %}
